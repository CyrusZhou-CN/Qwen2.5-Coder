import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats

# Load data
df = pd.read_csv('drebin-215-dataset-5560malware-9476-benign.csv')

# Data preprocessing - handle mixed data types
# Get only numeric columns (excluding 'class' column)
numeric_columns = []
for col in df.columns:
    if col != 'class':
        # Check if column is numeric or can be converted to numeric
        try:
            pd.to_numeric(df[col], errors='raise')
            numeric_columns.append(col)
        except:
            # Try to convert string columns to numeric if they contain only 0/1 values
            unique_vals = df[col].dropna().unique()
            if len(unique_vals) <= 2 and all(str(val) in ['0', '1', '0.0', '1.0'] for val in unique_vals):
                df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0).astype(int)
                numeric_columns.append(col)

# Calculate total active features per application using only numeric columns
df['total_features'] = df[numeric_columns].sum(axis=1, numeric_only=True)

# Create figure with 2x2 subplot layout
fig, axes = plt.subplots(2, 2, figsize=(16, 12))
fig.patch.set_facecolor('white')

# Define color palette
colors = ['#2E86AB', '#A23B72', '#F18F01', '#C73E1D']
malware_color = '#E74C3C'
benign_color = '#3498DB'

# Top-left: Histogram with KDE of total active features
ax1 = axes[0, 0]
n_bins = 30
counts, bins, patches = ax1.hist(df['total_features'], bins=n_bins, alpha=0.7, 
                                color=colors[0], density=True, edgecolor='white', linewidth=0.5)

# Add KDE curve
feature_range = df['total_features']
if len(feature_range) > 0 and feature_range.std() > 0:
    kde_x = np.linspace(feature_range.min(), feature_range.max(), 100)
    kde = stats.gaussian_kde(feature_range.values)
    kde_y = kde(kde_x)
    ax1.plot(kde_x, kde_y, color='#1B4F72', linewidth=3, label='KDE')
    ax1.legend(fontsize=11)

ax1.set_title('Distribution of Active Features per Application', fontweight='bold', fontsize=14, pad=15)
ax1.set_xlabel('Number of Active Features', fontsize=12)
ax1.set_ylabel('Density', fontsize=12)
ax1.grid(True, alpha=0.3)
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)

# Top-right: Box plot comparing malware vs benign
ax2 = axes[1, 0]
malware_data = df[df['class'] == 'M']['total_features'].values
benign_data = df[df['class'] == 'S']['total_features'].values

# Create box plots
if len(benign_data) > 0 and len(malware_data) > 0:
    bp1 = ax2.boxplot([benign_data], positions=[1], widths=0.4, patch_artist=True)
    bp2 = ax2.boxplot([malware_data], positions=[2], widths=0.4, patch_artist=True)
    
    # Color the boxes
    bp1['boxes'][0].set_facecolor(benign_color)
    bp1['boxes'][0].set_alpha(0.7)
    bp2['boxes'][0].set_facecolor(malware_color)
    bp2['boxes'][0].set_alpha(0.7)
    
    ax2.set_xticks([1, 2])
    ax2.set_xticklabels(['Benign', 'Malware'], fontsize=11)
else:
    ax2.text(0.5, 0.5, 'Insufficient data for comparison', 
             ha='center', va='center', transform=ax2.transAxes, fontsize=12)

ax2.set_title('Feature Activation: Malware vs Benign Apps', fontweight='bold', fontsize=14, pad=15)
ax2.set_xlabel('Application Type', fontsize=12)
ax2.set_ylabel('Number of Active Features', fontsize=12)
ax2.grid(True, alpha=0.3)
ax2.spines['top'].set_visible(False)
ax2.spines['right'].set_visible(False)

# Bottom-left: Bar chart of top 10 most frequently activated features
ax3 = axes[0, 1]
# Calculate feature sums for numeric columns only
feature_sums = df[numeric_columns].sum(numeric_only=True).sort_values(ascending=False)
top_10_features = feature_sums.head(10)

if len(top_10_features) > 0:
    # Create shortened feature names
    feature_names = []
    for feature in top_10_features.index:
        short_name = feature.replace('android.intent.action.', '').replace('TelephonyManager.', 'Tel.')
        if len(short_name) > 15:
            short_name = short_name[:13] + '..'
        feature_names.append(short_name)
    
    bars = ax3.bar(range(len(top_10_features)), top_10_features.values, 
                   color=[colors[i % len(colors)] for i in range(len(top_10_features))], alpha=0.8)
    
    ax3.set_xticks(range(len(feature_names)))
    ax3.set_xticklabels(feature_names, rotation=45, ha='right', fontsize=10)
else:
    ax3.text(0.5, 0.5, 'No numeric features found', 
             ha='center', va='center', transform=ax3.transAxes, fontsize=12)

ax3.set_title('Top 10 Most Activated Features', fontweight='bold', fontsize=14, pad=15)
ax3.set_xlabel('Features', fontsize=12)
ax3.set_ylabel('Total Activations', fontsize=12)
ax3.grid(True, alpha=0.3, axis='y')
ax3.spines['top'].set_visible(False)
ax3.spines['right'].set_visible(False)

# Bottom-right: Stacked histogram of high-risk features
ax4 = axes[1, 1]
high_risk_features = ['SEND_SMS', 'READ_PHONE_STATE', 'INTERNET', 'WRITE_EXTERNAL_STORAGE']

# Check which features exist in the numeric columns
available_features = [f for f in high_risk_features if f in numeric_columns]

if available_features and len(df[df['class'] == 'M']) > 0 and len(df[df['class'] == 'S']) > 0:
    # Create stacked histogram data
    malware_counts = []
    benign_counts = []
    feature_labels = []

    for feature in available_features:
        malware_count = int(df[df['class'] == 'M'][feature].sum())
        benign_count = int(df[df['class'] == 'S'][feature].sum())
        malware_counts.append(malware_count)
        benign_counts.append(benign_count)
        feature_labels.append(feature.replace('_', '\n'))

    x_pos = np.arange(len(available_features))
    width = 0.6

    # Create stacked bars
    bars1 = ax4.bar(x_pos, benign_counts, width, label='Benign', color=benign_color, alpha=0.8)
    bars2 = ax4.bar(x_pos, malware_counts, width, bottom=benign_counts, label='Malware', 
                    color=malware_color, alpha=0.8)

    # Add value labels
    for i, (benign, malware) in enumerate(zip(benign_counts, malware_counts)):
        total = benign + malware
        if total > 0:
            ax4.text(i, total + total*0.02, f'{total}', ha='center', va='bottom', 
                    fontweight='bold', fontsize=10)

    ax4.set_xticks(x_pos)
    ax4.set_xticklabels(feature_labels, fontsize=11)
    ax4.legend(fontsize=11, loc='upper right')
    ax4.set_ylabel('Number of Applications', fontsize=12)
else:
    ax4.text(0.5, 0.5, 'High-risk features not available\nor insufficient data', 
             ha='center', va='center', transform=ax4.transAxes, fontsize=14)

ax4.set_title('High-Risk Features: Malware vs Benign Distribution', fontweight='bold', fontsize=14, pad=15)
ax4.set_xlabel('High-Risk Features', fontsize=12)
ax4.grid(True, alpha=0.3, axis='y')
ax4.spines['top'].set_visible(False)
ax4.spines['right'].set_visible(False)

# Adjust layout to prevent overlap
plt.tight_layout(pad=2.0)
plt.savefig('android_malware_distribution_analysis.png', dpi=300, bbox_inches='tight')
plt.show()